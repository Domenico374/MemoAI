<script>
const out = document.getElementById('out');

function log(line) {
  out.textContent += line + '\n';
}

document.getElementById('go').onclick = async () => {
  const f = document.getElementById('file').files[0];
  if (!f) return alert('Seleziona un file');

  out.textContent = '1) chiedo l’URL...\n';
  try {
    const r = await fetch('/api/blob-url', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ filename: f.name, contentType: f.type || 'application/octet-stream' })
    });

    const text = await r.text();
    log(`/api/blob-url → HTTP ${r.status}`);
    log(text);

    if (!r.ok) return; // mostriamo il body d'errore e stop

    let j;
    try { j = JSON.parse(text); } catch { j = {}; }
    if (!j.ok || !j.uploadUrl) {
      log('Risposta senza uploadUrl, interrompo.');
      return;
    }

    log('\n2) carico il file...');
    const up = await fetch(j.uploadUrl, { method: 'POST', body: f });
    const upText = await up.text();
    log(`upload → HTTP ${up.status}`);
    log(upText);

    if (up.ok) {
      const publicUrl = 'https://blob.vercel-storage.com' + (j.blobPath || '');
      log(`\nFatto! Percorso: ${j.blobPath || '(sconosciuto)'}\nURL (stima): ${publicUrl}`);
    }
  } catch (e) {
    log('ERRORE JS: ' + (e.message || e));
  }
};
</script>
