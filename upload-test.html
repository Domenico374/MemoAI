<!doctype html>
<html lang="it">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Upload Test</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<main class="container">
  <h1>Test upload → extract</h1>
  <input type="file" id="f" />
  <button id="btnUp">Carica</button>
  <button id="btnExt" disabled>Estrai testo</button>
  <article>
    <h3>Anteprima</h3>
    <div id="prev" style="overflow:auto;max-height:260px;border:1px dashed #ccc;padding:8px"></div>
  </article>
  <article>
    <h3>Risposta</h3>
    <pre id="out" style="min-height:140px"></pre>
  </article>
</main>

<script>
let lastDataURL = null, lastName = null;
const $ = s => document.querySelector(s);

$('#btnUp').onclick = async () => {
  const f = $('#f').files[0];
  if (!f) { alert('Scegli un file'); return; }
  const fd = new FormData(); fd.append('file', f, f.name);
  const r = await fetch('/api/upload', { method:'POST', body: fd });
  const j = await r.json().catch(()=> ({}));
  $('#out').textContent = JSON.stringify(j, null, 2);
  if (j?.ok && j?.url) {
    lastDataURL = j.url; lastName = j.name || f.name;
    $('#btnExt').disabled = false;
    if ((j.mime||'').startsWith('image/')) {
      $('#prev').innerHTML = `<img src="${j.url}" style="max-width:100%">`;
    } else {
      $('#prev').textContent = j.url.slice(0,120) + '…';
    }
  } else {
    $('#btnExt').disabled = true;
  }
};

$('#btnExt').onclick = async () => {
  if (!lastDataURL) return;
  const r = await fetch('/api/extract', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ dataURL: lastDataURL, fileName: lastName })
  });
  const j = await r.json().catch(()=> ({}));
  $('#out').textContent = JSON.stringify(j, null, 2);
};
</script>
