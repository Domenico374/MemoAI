<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memo AI</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js per le statistiche -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Librerie fallback client-side -->
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
    }
  </script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <style>
    body { background:#f5f7fb }
    #log { white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace }
    
    /* Drag & Drop Styles */
    .drop-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 0.75rem;
      transition: all 0.3s ease;
      background: #f8fafc;
    }
    .drop-zone.dragover {
      border-color: #3b82f6;
      background: #eff6ff;
      transform: scale(1.02);
    }
    .drop-zone.dragover .drop-text {
      color: #3b82f6;
    }
    
    /* Progress Bar per file grandi */
    .large-file-progress {
      background: #f1f5f9;
      border: 2px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .progress-info {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .progress-bar-large {
      height: 12px;
      background: #e2e8f0;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .progress-fill-large {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      transition: width 0.3s ease;
      border-radius: 6px;
    }
    
    /* Anteprima personalizzata */
    .preview-card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .preview-header {
      background: #f1f5f9;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e2e8f0;
      font-weight: 600;
    }
    .preview-content {
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
    }
    
    /* Animazioni */
    .fade-out {
      opacity: 0;
      transform: translateX(-100%);
      transition: all 0.5s ease;
    }
    
    /* AI Analysis Styles */
    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .ai-badge.positive { background: #dcfce7; color: #166534; }
    .ai-badge.neutral { background: #fef3c7; color: #92400e; }
    .ai-badge.negative { background: #fee2e2; color: #991b1b; }
    .ai-badge.info { background: #dbeafe; color: #1e40af; }
    
    .decision-item {
      border-left: 3px solid #10b981;
      background: #f0fdf4;
      padding: 0.75rem;
      margin: 0.5rem 0;
    }
    
    .action-item {
      border-left: 3px solid #3b82f6;
      background: #eff6ff;
      padding: 0.75rem;
      margin: 0.5rem 0;
    }
    
    .sentiment-bar {
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      overflow: hidden;
    }
    
    .sentiment-fill {
      height: 100%;
      transition: width 0.5s ease;
    }
    
    /* Statistiche */
    .stat-card {
      background: white;
      border-radius: 0.5rem;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="text-slate-800">
  <div class="max-w-6xl mx-auto p-6">

    <!-- HEADER -->
    <header class="mb-6 flex items-center gap-4">
      <img src="https://raw.githubusercontent.com/Domenico374/domenico374.github.io/main/img/logo-memoai.png"
           alt="Memo AI Logo" class="h-16 w-auto">
      <div>
        <h1 class="text-3xl font-bold">Memo AI</h1>
        <p class="text-sm text-slate-600">Carica PDF/DOCX/TXT/MD o Audio â†’ Estrazione/Trascrizione â†’ Verbale</p>
      </div>
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
      <!-- COLONNA SINISTRA -->
      <div class="xl:col-span-2 space-y-6">
        
        <!-- CARICA FILE con Drag & Drop -->
        <section class="bg-white rounded-2xl shadow p-5">
          <div class="flex items-start justify-between gap-3 mb-4">
            <div>
              <h2 class="text-lg font-semibold">Carica file</h2>
              <p class="text-xs text-slate-500 mt-1">PDF, DOCX, TXT/MD, MP3/M4A/WAV/OGG/WEBM (fino a 200MB)</p>
            </div>
            <input id="uploader" type="file" multiple
                   accept=".pdf,.docx,.txt,.md,.mp3,.m4a,.wav,.ogg,.webm"
                   class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200" />
          </div>
          
          <!-- Zona Drag & Drop -->
          <div id="dropZone" class="drop-zone p-8 text-center cursor-pointer">
            <div class="drop-text text-slate-500">
              <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
              </svg>
              <p class="font-medium">Trascina i file qui</p>
              <p class="text-sm mt-1">oppure <span class="text-blue-600">clicca per selezionare</span></p>
            </div>
          </div>
          
          <!-- Progress Bar per File Grandi -->
          <div id="largeFileProgress" class="large-file-progress hidden">
            <div class="progress-info">
              <span id="largeFileName" class="font-medium text-sm"></span>
              <span id="largeFilePercent" class="text-sm text-slate-600">0%</span>
            </div>
            <div class="progress-bar-large">
              <div id="largeFileProgressFill" class="progress-fill-large" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs text-slate-500 mt-2">
              <span id="largeFileChunkInfo">Chunk 0/0</span>
              <span id="largeFileSizeInfo">0 MB / 0 MB</span>
            </div>
          </div>
          
          <div id="fileQueue" class="mt-4 space-y-2"></div>
        </section>

        <!-- ANALISI AI -->
        <section class="bg-white rounded-2xl shadow p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Analisi AI Intelligente</h2>
            <button id="btnAnalyze" class="px-4 py-2 rounded-lg text-sm bg-purple-600 text-white hover:bg-purple-700 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              Analizza Contenuto
            </button>
          </div>
          
          <div id="aiAnalysis" class="space-y-4">
            <!-- Riepilogo Intelligente -->
            <div class="border border-slate-200 rounded-lg p-4">
              <h3 class="font-semibold text-sm mb-2 flex items-center gap-2">
                <span class="ai-badge info">ðŸ¤–</span>
                Riepilogo Intelligente
              </h3>
              <div id="aiSummary" class="text-sm text-slate-600 bg-slate-50 rounded p-3 min-h-[60px]">
                <p class="text-slate-400">Il riepilogo automatico apparirÃ  qui dopo l'analisi...</p>
              </div>
            </div>
            
            <!-- Decisioni e Action Items -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="border border-slate-200 rounded-lg p-4">
                <h3 class="font-semibold text-sm mb-2 flex items-center gap-2">
                  <span class="ai-badge positive">âœ…</span>
                  Decisioni Identificate
                </h3>
                <div id="aiDecisions" class="space-y-2 max-h-[200px] overflow-y-auto">
                  <p class="text-slate-400 text-sm">Nessuna decisione identificata ancora</p>
                </div>
              </div>
              
              <div class="border border-slate-200 rounded-lg p-4">
                <h3 class="font-semibold text-sm mb-2 flex items-center gap-2">
                  <span class="ai-badge info">ðŸ“‹</span>
                  Action Items
                </h3>
                <div id="aiActions" class="space-y-2 max-h-[200px] overflow-y-auto">
                  <p class="text-slate-400 text-sm">Nessun task identificato ancora</p>
                </div>
              </div>
            </div>
            
            <!-- Analisi Sentiment -->
            <div class="border border-slate-200 rounded-lg p-4">
              <h3 class="font-semibold text-sm mb-3 flex items-center gap-2">
                <span class="ai-badge neutral">ðŸ˜Š</span>
                Analisi del Tono
              </h3>
              <div class="space-y-3">
                <div>
                  <div class="flex justify-between text-xs mb-1">
                    <span>Sentiment</span>
                    <span id="sentimentScore" class="font-medium">--</span>
                  </div>
                  <div class="sentiment-bar">
                    <div id="sentimentFill" class="sentiment-fill bg-gradient-to-r from-red-500 via-yellow-500 to-green-500" style="width: 50%"></div>
                  </div>
                </div>
                <div id="sentimentInsights" class="text-sm text-slate-600">
                  <p class="text-slate-400">L'analisi del tono apparirÃ  qui...</p>
                </div>
              </div>
            </div>
            
            <!-- Suggerimenti -->
            <div class="border border-slate-200 rounded-lg p-4">
              <h3 class="font-semibold text-sm mb-2 flex items-center gap-2">
                <span class="ai-badge info">ðŸ’¡</span>
                Suggerimenti Miglioramento
              </h3>
              <div id="aiSuggestions" class="text-sm text-slate-600 space-y-2">
                <p class="text-slate-400">I suggerimenti appariranno qui dopo l'analisi...</p>
              </div>
            </div>
          </div>
        </section>

        <!-- APPUNTI -->
        <section class="bg-white rounded-2xl shadow p-5">
          <h2 class="text-lg font-semibold mb-3">Appunti</h2>
          <textarea id="notes" rows="8"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Appunti trascritti o estrattiâ€¦"></textarea>

          <div class="mt-4 flex flex-wrap gap-2 items-center">
            <button id="btnGenerate"
              class="px-4 py-2 rounded-lg text-sm bg-blue-600 text-white hover:bg-blue-700">Genera verbale</button>
            
            <!-- TEMPLATE PERSONALIZZATI -->
            <select id="template" class="px-3 py-2 rounded-lg text-sm border border-gray-300">
              <option value="standard">Standard</option>
              <option value="formale">Formale</option>
              <option value="esecutivo">Esecutivo</option>
              <option value="tecnico">Tecnico</option>
              <option value="informale">Informale</option>
            </select>
            
            <button id="btnManageTemplates" class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">
              Gestisci Template
            </button>
            <button id="btnReset" class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Reset</button>
            <button id="btnLoadLast" class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Carica ultimo</button>
          </div>
        </section>

        <!-- VERBALE -->
        <section class="bg-white rounded-2xl shadow p-5">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Verbale</h2>
            <div class="flex gap-2">
              <button id="btnCopy" class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Copia</button>
              <button id="btnDownload" class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Scarica .md</button>
              <button id="btnExportPDF" class="px-3 py-2 rounded-lg text-sm bg-green-600 text-white hover:bg-green-700">Esporta PDF</button>
            </div>
          </div>
          <textarea id="result" rows="12"
            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm leading-6"
            placeholder="Il verbale comparirÃ  qui..."></textarea>
        </section>
      </div>

      <!-- COLONNA DESTRA -->
      <div class="space-y-6">
        
        <!-- INFO RIUNIONE -->
        <section class="bg-white rounded-2xl shadow p-5">
          <h2 class="text-lg font-semibold mb-3">Informazioni riunione</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Data riunione</label>
              <input id="meetingDate" type="date"
                     class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Oggetto</label>
              <input id="subject" type="text" placeholder="Es. Pianificazione Q1 2025"
                     class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Partecipanti</label>
              <input id="participants" type="text" placeholder="Es. Mario Rossi, Laura Bianchi, etc."
                     class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Progetto/Cliente</label>
              <input id="project" type="text" placeholder="Es. Progetto Alpha"
                     class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
          </div>
        </section>

        <!-- STATISTICHE -->
        <section class="bg-white rounded-2xl shadow p-5">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Statistiche</h2>
            <button id="btnRefreshStats" class="px-3 py-1 rounded text-xs bg-slate-100 hover:bg-slate-200">Aggiorna</button>
          </div>
          
          <div class="space-y-4">
            <!-- Metriche Veloci -->
            <div class="grid grid-cols-2 gap-3">
              <div class="stat-card text-center">
                <div class="text-2xl font-bold text-blue-600" id="statMeetings">0</div>
                <div class="text-xs text-slate-500">Riunioni</div>
              </div>
              <div class="stat-card text-center">
                <div class="text-2xl font-bold text-green-600" id="statDecisions">0</div>
                <div class="text-xs text-slate-500">Decisioni</div>
              </div>
              <div class="stat-card text-center">
                <div class="text-2xl font-bold text-purple-600" id="statActions">0</div>
                <div class="text-xs text-slate-500">Task</div>
              </div>
              <div class="stat-card text-center">
                <div class="text-2xl font-bold text-amber-600" id="statDuration">0m</div>
                <div class="text-xs text-slate-500">Durata media</div>
              </div>
            </div>
            
            <!-- Grafico Partecipazione -->
            <div class="stat-card">
              <h3 class="font-semibold text-sm mb-3">Partecipazione</h3>
              <canvas id="participationChart" height="150"></canvas>
            </div>
            
            <!-- Trend Mensile -->
            <div class="stat-card">
              <h3 class="font-semibold text-sm mb-3">Trend Riunioni</h3>
              <canvas id="trendChart" height="150"></canvas>
            </div>
          </div>
        </section>

        <!-- ANTEPRIMA -->
        <section class="bg-white rounded-2xl shadow p-5">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Anteprima</h2>
            <div class="flex gap-2">
              <button id="btnClearPreview"
                      class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Pulisci</button>
              <button id="btnTogglePreview"
                      class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Nascondi</button>
            </div>
          </div>
          <div id="preview" class="preview-card">
            <div class="preview-header flex items-center justify-between">
              <span>Contenuto estratto</span>
              <span id="previewInfo" class="text-xs text-slate-500 font-normal"></span>
            </div>
            <div class="preview-content">
              <p class="text-slate-500">L'anteprima comparirÃ  quiâ€¦</p>
            </div>
          </div>
        </section>

        <!-- LOG -->
        <section class="bg-white rounded-2xl shadow p-5">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-semibold">Log</h2>
            <button id="btnClearLog" class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Pulisci Log</button>
          </div>
          <pre id="log" class="text-xs bg-slate-900 text-slate-100 p-3 rounded max-h-40 overflow-y-auto">prontoâ€¦</pre>
        </section>
      </div>
    </div>
  </div>

  <!-- MODAL TEMPLATE PERSONALIZZATI -->
  <div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Gestione Template Personalizzati</h3>
        <button id="btnCloseModal" class="text-slate-500 hover:text-slate-700">âœ•</button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Nuovo Template</label>
          <input type="text" id="newTemplateName" placeholder="Nome template" 
                 class="w-full p-2 border border-gray-300 rounded-lg mb-2">
          <textarea id="newTemplateContent" rows="6" placeholder="Contenuto del template..."
                    class="w-full p-2 border border-gray-300 rounded-lg text-sm"></textarea>
          <button id="btnSaveTemplate" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
            Salva Template
          </button>
        </div>
        
        <div>
          <h4 class="font-medium mb-2">Template Esistenti</h4>
          <div id="templateList" class="space-y-2">
            <!-- Template verranno caricati qui -->
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== Helpers
  const $ = s => document.querySelector(s);
  const logEl = $('#log');
  function log(){ 
    const message = Array.from(arguments).join(' ');
    logEl.textContent += '\n' + message;
    logEl.scrollTop = logEl.scrollHeight;
  }
  
  function setPreview(content, fileName = '', type = 'text') {
    const previewContent = $('#preview .preview-content');
    const previewInfo = $('#previewInfo');
    
    if (!content) {
      previewContent.innerHTML = '<p class="text-slate-500">L\'anteprima comparirÃ  quiâ€¦</p>';
      previewInfo.textContent = '';
      return;
    }
    
    if (type === 'pdf') {
      previewContent.innerHTML = `
        <div class="space-y-2">
          <div class="flex items-center gap-2 text-sm text-slate-600">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
            </svg>
            PDF Document
          </div>
          <div class="bg-amber-50 border border-amber-200 rounded p-3">
            <p class="text-amber-800 text-sm"><strong>Anteprima PDF:</strong> ${escapeHTML(fileName)}</p>
            <pre class="mt-2 text-xs bg-white p-2 rounded border">${escapeHTML(content.slice(0, 3000))}</pre>
          </div>
        </div>`;
    } else if (type === 'audio') {
      previewContent.innerHTML = `
        <div class="space-y-2">
          <div class="flex items-center gap-2 text-sm text-slate-600">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"/>
            </svg>
            File Audio
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded p-3">
            <p class="text-blue-800 text-sm"><strong>Trascrizione audio:</strong> ${escapeHTML(fileName)}</p>
            <pre class="mt-2 text-xs bg-white p-2 rounded border">${escapeHTML(content.slice(0, 3000))}</pre>
          </div>
        </div>`;
    } else {
      previewContent.innerHTML = `
        <div class="space-y-2">
          <div class="flex items-center gap-2 text-sm text-slate-600">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
            </svg>
            Documento di testo
          </div>
          <pre class="text-xs bg-slate-50 p-3 rounded border">${escapeHTML(content.slice(0, 5000))}</pre>
        </div>`;
    }
    
    previewInfo.textContent = fileName ? `File: ${fileName}` : '';
  }
  
  function escapeHTML(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function extOf(name){ return (name.split('.').pop()||'').toLowerCase(); }
  function fmtSize(b){ if(b<1024) return b+' B'; if(b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }

  // ===== Chunk Uploader per file grandi
  class ChunkUploader {
    constructor() {
      this.chunkSize = 4 * 1024 * 1024; // 4MB per chunk (compatibile con Vercel)
    }

    async uploadLargeFile(file) {
      const totalChunks = Math.ceil(file.size / this.chunkSize);
      const fileName = file.name;
      
      log(`ðŸ“¦ Dividendo file ${fileName} in ${totalChunks} chunk...`);
      
      // Mostra progress bar per file grandi
      this.showLargeFileProgress(fileName, file.size, totalChunks);
      
      let uploadedSize = 0;
      
      for (let i = 0; i < totalChunks; i++) {
        const start = i * this.chunkSize;
        const end = Math.min(start + this.chunkSize, file.size);
        const chunk = file.slice(start, end);
        
        // Converti chunk in base64
        const chunkData = await this.chunkToBase64(chunk);
        
        const formData = {
          fileName: fileName,
          chunkIndex: i,
          totalChunks: totalChunks,
          fileData: chunkData
        };

        try {
          const response = await fetch('/api/chunk-upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const result = await response.json();
          
          uploadedSize += chunk.size;
          const progress = Math.round((uploadedSize / file.size) * 100);
          
          this.updateLargeFileProgress(i + 1, totalChunks, progress, uploadedSize, file.size);
          
          log(`âœ… Chunk ${i + 1}/${totalChunks} uploadato (${progress}%)`);
          
        } catch (error) {
          log(`âŒ Errore chunk ${i + 1}:`, error.message);
          this.hideLargeFileProgress();
          throw error;
        }
      }

      // Unisci i chunk
      log("ðŸ”— Unione chunk...");
      try {
        const mergeResponse = await fetch('/api/merge-chunks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fileName: fileName,
            totalChunks: totalChunks
          })
        });

        if (!mergeResponse.ok) {
          throw new Error(`Merge failed: ${mergeResponse.status}`);
        }

        const result = await mergeResponse.json();
        this.hideLargeFileProgress();
        log(`ðŸŽ‰ File ${fileName} assemblato con successo!`);
        
        return result;
        
      } catch (error) {
        this.hideLargeFileProgress();
        log('âŒ Errore unione chunk:', error.message);
        throw error;
      }
    }

    chunkToBase64(chunk) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.readAsDataURL(chunk);
      });
    }

    showLargeFileProgress(fileName, totalSize, totalChunks) {
      $('#largeFileName').textContent = fileName;
      $('#largeFileProgress').classList.remove('hidden');
      this.updateLargeFileProgress(0, totalChunks, 0, 0, totalSize);
    }

    updateLargeFileProgress(currentChunk, totalChunks, progress, uploadedSize, totalSize) {
      $('#largeFilePercent').textContent = `${progress}%`;
      $('#largeFileProgressFill').style.width = `${progress}%`;
      $('#largeFileChunkInfo').textContent = `Chunk ${currentChunk}/${totalChunks}`;
      $('#largeFileSizeInfo').textContent = 
        `${(uploadedSize / 1024 / 1024).toFixed(1)} MB / ${(totalSize / 1024 / 1024).toFixed(1)} MB`;
    }

    hideLargeFileProgress() {
      $('#largeFileProgress').classList.add('hidden');
    }
  }

  // ===== Coda caricamenti (UI)
  const queueEl = $('#fileQueue');
  const queueMap = new Map();
  const completedItems = new Set();
  
  function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  
  function addQueueItem(file){
    const id = uid();
    const row = document.createElement('div');
    row.className = 'flex items-center justify-between border border-slate-200 rounded-lg p-2 text-sm bg-white transition-all duration-300';
    row.dataset.id = id;
    row.innerHTML = `
      <div class="flex items-center gap-2 min-w-0">
        <span class="inline-block w-2.5 h-2.5 rounded-full bg-slate-300" data-dot></span>
        <span class="truncate max-w-[220px]" title="${file.name}">${file.name}</span>
        <span class="text-xs text-slate-500">Â· ${fmtSize(file.size||0)}</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-40 h-2 bg-slate-100 rounded overflow-hidden">
          <div class="h-2 bg-blue-500 transition-all" style="width:0%" data-bar></div>
        </div>
        <span class="text-xs text-slate-600 min-w-[80px]" data-status>in attesaâ€¦</span>
        <button class="text-slate-400 hover:text-slate-600 transition-colors" data-remove title="Rimuovi">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>`;
    
    queueEl?.appendChild(row);
    queueMap.set(id, {
      row, dot: row.querySelector('[data-dot]'),
      bar: row.querySelector('[data-bar]'),
      status: row.querySelector('[data-status]'),
      remove: row.querySelector('[data-remove]'),
      timer: null
    });
    
    // Gestione rimozione manuale
    row.querySelector('[data-remove]').addEventListener('click', () => {
      removeQueueItem(id);
    });
    
    return id;
  }
  
  function setQueueState(id, state, text, progress){
    const els = queueMap.get(id); 
    if(!els) return;
    
    if (typeof progress==='number') els.bar.style.width = Math.max(0,Math.min(100,progress))+'%';
    if (text) els.status.textContent = text;
    
    const colors = { 
      queued:'bg-slate-300', 
      uploading:'bg-blue-400', 
      processing:'bg-amber-400', 
      done:'bg-emerald-500', 
      error:'bg-rose-500' 
    };
    els.dot.className = 'inline-block w-2.5 h-2.5 rounded-full ' + (colors[state] || 'bg-slate-300');
    
    // Programma pulizia automatica per gli item completati
    if ((state === 'done' || state === 'error') && !completedItems.has(id)) {
      completedItems.add(id);
      els.timer = setTimeout(() => {
        removeQueueItem(id);
      }, 5000); // Rimuove dopo 5 secondi
    }
  }
  
  function removeQueueItem(id) {
    const els = queueMap.get(id);
    if (els) {
      if (els.timer) clearTimeout(els.timer);
      els.row.classList.add('fade-out');
      setTimeout(() => {
        els.row.remove();
        queueMap.delete(id);
        completedItems.delete(id);
      }, 500);
    }
  }

  // ===== Drag & Drop
  const dropZone = $('#dropZone');
  const uploader = $('#uploader');

  dropZone.addEventListener('click', () => uploader.click());
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });
  
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.add('dragover');
    }, false);
  });
  
  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.remove('dragover');
    }, false);
  });
  
  dropZone.addEventListener('drop', (e) => {
    const files = Array.from(e.dataTransfer.files);
    if (files.length) {
      log('ðŸŽ¯ File trascinati:', files.length);
      handleFiles(files);
    }
  });

  // ===== Upload e gestione file
  async function handleFiles(files){
    log('ðŸ“ File selezionati:', files.length);
    
    for (const file of files){
      const name = file.name || 'file';
      const ext  = extOf(name);
      const id   = addQueueItem(file);

      try {
        setQueueState(id,'queued','in attesaâ€¦',0);
        log(`ðŸ“„ Elaborando: ${name} (${fmtSize(file.size)})`);

        // TXT/MD - gestione locale immediata
        if (['txt','md'].includes(ext)){
          setQueueState(id,'processing','import localeâ€¦',30);
          const t = await file.text();
          setPreview(t, name, 'text');
          $('#notes').value = ($('#notes').value ? $('#notes').value + '\n---\n' : '') + t;
          saveToLocal();
          setQueueState(id,'done','completato',100);
          log(`âœ… TXT/MD elaborato: ${name}`);
          continue;
        }

        // File audio grandi (> 50MB) usano chunk upload
        if (['mp3','m4a','wav','ogg','webm'].includes(ext) && file.size > 50 * 1024 * 1024) {
          setQueueState(id,'uploading','upload chunkâ€¦',10);
          
          const uploader = new ChunkUploader();
          const result = await uploader.uploadLargeFile(file);
          
          // Dopo l'upload, procedi con la trascrizione
          setQueueState(id,'processing','trascrizioneâ€¦',80);
          const transcription = await transcribe(`uploaded://${name}`);
          const text = transcription.text;
          
          setPreview(text, name, 'audio');
          $('#notes').value = ($('#notes').value ? $('#notes').value + '\n---\n' : '') + text;
          saveToLocal();
          setQueueState(id,'done','completato',100);
          log(`âœ… Audio grande trascritto: ${name}`);
          continue;
        }

        // Upload normale per file piccoli
        setQueueState(id,'uploading','caricamentoâ€¦',5);
        
        try {
          const url = await upload(file, p=>setQueueState(id,'uploading',`caricamentoâ€¦ ${p}%`,p));
          setQueueState(id,'processing','elaborazioneâ€¦',60);

          if (['pdf','docx'].includes(ext)){
            let text = '';
            try {
              const result = await extract(url, name);
              text = result.text;
              log(`âœ… Backend extract: ${name}`);
            } catch (e) {
              log('âš ï¸ Extract backend non disponibile, uso fallback client:', e.message);
              text = ext==='pdf' ? await extractPdfClient(file) : await extractDocxClient(file);
              log(`âœ… Fallback client: ${name}`);
            }
            setPreview(text, name, 'pdf');
            $('#notes').value = ($('#notes').value ? $('#notes').value + '\n---\n' : '') + text;
            saveToLocal();
            setQueueState(id,'done','completato',100);
            
          } else if (['mp3','m4a','wav','ogg','webm'].includes(ext)){
            const result = await transcribe(url);
            const text = result.text;
            setPreview(text, name, 'audio');
            $('#notes').value = ($('#notes').value ? $('#notes').value + '\n---\n' : '') + text;
            saveToLocal();
            setQueueState(id,'done','completato',100);
            log(`âœ… Audio trascritto: ${name}`);
            
          } else {
            setQueueState(id,'error',`formato non gestito: ${ext}`,100);
            log(`âŒ Formato non supportato: ${ext}`);
          }
        } catch (uploadError) {
          if (['pdf','docx'].includes(ext)) {
            log('âš ï¸ Upload fallito, provo fallback client...');
            setQueueState(id,'processing','fallback clientâ€¦',50);
            try {
              const text = ext==='pdf' ? await extractPdfClient(file) : await extractDocxClient(file);
              setPreview(text, name, 'pdf');
              $('#notes').value = ($('#notes').value ? $('#notes').value + '\n---\n' : '') + text;
              saveToLocal();
              setQueueState(id,'done','completato (client)',100);
              log(`âœ… Fallback client riuscito: ${name}`);
            } catch (fallbackError) {
              setQueueState(id,'error', fallbackError.message, 100);
              throw fallbackError;
            }
          } else {
            throw uploadError;
          }
        }
        
      } catch (e){
        setQueueState(id,'error', e.message || 'errore', 100);
        log('âŒ Errore elaborazione', name + ':', e.message || e);
      }
    }
  }

  // Funzioni di upload/elaborazione esistenti mantenute per compatibilitÃ 
  function upload(file, onProgress){
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      
      const ext = extOf(file.name);
      let endpoint = '';
      
      if (['pdf','docx','txt','md'].includes(ext)) {
        endpoint = '/api/extract';
      } else if (['mp3','m4a','wav','ogg','webm'].includes(ext)) {
        endpoint = '/api/audio-upload';
      } else {
        reject(new Error(`Formato non supportato: ${ext}`));
        return;
      }
      
      xhr.open('POST', endpoint);
      xhr.upload.onprogress = (e)=>{ 
        if(e.lengthComputable && onProgress){ 
          onProgress(Math.round((e.loaded/e.total)*100)); 
        } 
      };
      
      xhr.onload = () => {
        let j = null; 
        try{ j = JSON.parse(xhr.responseText); } catch(e){}
        
        if (xhr.status >= 200 && xhr.status < 300) {
          resolve(`uploaded://${file.name}`);
        } else {
          reject(new Error((j && (j.error||j.message)) || `Upload fallito (${xhr.status})`));
        }
      };
      
      xhr.onerror = () => reject(new Error('Errore di rete durante l\'upload'));
      
      const fd = new FormData();
      if (['mp3','m4a','wav','ogg','webm'].includes(ext)) {
        fd.append('audio', file);
      } else {
        fd.append('file', file);
      }
      xhr.send(fd);
    });
  }

  async function extract(url, name){
    return new Promise(resolve => {
      setTimeout(() => {
        resolve({ text: `Testo estratto dal file: ${name}\n\nQuesto Ã¨ un contenuto di esempio estratto dal documento. In una situazione reale, qui ci sarebbe il testo effettivo del file.` });
      }, 1000);
    });
  }

  async function transcribe(url){
    return new Promise(resolve => {
      setTimeout(() => {
        resolve({ text: `Trascrizione audio: ${url}\n\nQuesta Ã¨ una simulazione della trascrizione di un file audio. In produzione, qui ci sarebbe il testo effettivo riconosciuto dal servizio di trascrizione.` });
      }, 1500);
    });
  }

  // Fallback client-side
  async function extractPdfClient(file){
    if (!window.pdfjsLib) throw new Error('PDF.js non disponibile');
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
    const max = Math.min(pdf.numPages, 5);
    let text = '';
    for(let i=1;i<=max;i++){
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      text += content.items.map(it=>it.str).join(' ') + '\n\n';
    }
    return text.trim();
  }

  async function extractDocxClient(file){
    if (!window.mammoth) throw new Error('Mammoth non disponibile');
    const buf = await file.arrayBuffer();
    const res = await window.mammoth.extractRawText({ arrayBuffer: buf });
    return (res && res.value) ? res.value.trim() : '';
  }

  // ===== [RESTANTE CODICE IMMUTATO - Analisi AI, Statistiche, Template, etc.]
  // ... (mantieni tutto il resto del codice esistente per analisi AI, statistiche, template, generazione verbale, etc.)

  // ===== Inizializzazione
  log('ðŸš€ Memo AI Advanced caricato! Supporto per file fino a 200MB attivo.');
})();
</script>
</body>
</html>
