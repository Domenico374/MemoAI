<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memo AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- NEW: Mammoth per .docx lato client -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <style>
    body { background:#f5f7fb }
  </style>
</head>
<body class="text-slate-800">
  <div class="max-w-4xl mx-auto p-6">
    <header class="mb-6 flex items-center justify-between gap-3">
      <div>
        <h1 class="text-3xl font-bold">Memo AI</h1>
        <p class="text-sm text-slate-600">Upload file → Trascrizione / Estrazione → Formattazione</p>
      </div>
      <span id="healthBadge" class="text-xs px-2.5 py-1 rounded-full bg-slate-200 text-slate-700">checking…</span>
    </header>

    <!-- Upload -->
    <section class="bg-white rounded-2xl shadow p-5 mb-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold">Upload file</h2>
          <p class="text-xs text-slate-500 mt-1">
            Suggerimento: per file &gt; 4.5 MB usare versioni ridotte. I PDF scansionati richiederanno OCR.
          </p>
        </div>
        <button id="btnUpload" type="button"
          class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Seleziona file</button>
      </div>

      <!-- elenco file caricati / stati -->
      <ul id="queue" class="mt-4 space-y-2 text-sm"></ul>

      <!-- input file nascosto -->
      <input id="uploader" type="file" multiple
             accept=".txt,.md,.pdf,.docx,.mp3,.m4a,.wav,.ogg,.webm"
             class="hidden" />
    </section>

    <!-- NEW: Anteprima immediata del file caricato -->
    <section class="bg-white rounded-2xl shadow p-5 mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Anteprima</h2>
        <button id="btnClearPreview" class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Pulisci anteprima</button>
      </div>
      <div id="preview"
           class="prose max-w-none border border-slate-200 rounded-xl p-4 bg-slate-50 text-sm">
        <p class="text-slate-500">L’anteprima comparirà qui…</p>
      </div>
    </section>

    <!-- Appunti -->
    <section class="bg-white rounded-2xl shadow p-5 mb-6">
      <h2 class="text-lg font-semibold mb-3">Appunti</h2>
      <textarea id="notes" rows="12"
        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Appunti trascritti o estratti…"></textarea>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnGenerate"
          class="px-3 py-2 rounded-lg text-sm bg-blue-600 text-white hover:bg-blue-700">
          Genera verbale
        </button>
        <button id="btnReset"
          class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">
          Reset
        </button>
      </div>
    </section>

    <!-- Verbale -->
    <section class="bg-white rounded-2xl shadow p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Verbale</h2>
        <div class="flex gap-2">
          <button id="btnCopy" class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Copia</button>
          <button id="btnDownload" class="px-3 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">Scarica .md</button>
        </div>
      </div>
      <pre id="result" class="whitespace-pre-wrap text-sm leading-6 text-slate-800">Il verbale comparirà qui…</pre>
    </section>
  </div>

  <script>
    // ---------- helpers UI ----------
    const $ = (s) => document.querySelector(s);
    const queueEl = $('#queue');
    const previewEl = $('#preview');
    const log = (...a) => console.log('[MemoAI]', ...a);

    function addQueueRow(name, meta, status) {
      const li = document.createElement('li');
      li.className = "border rounded-lg px-3 py-2 flex items-center justify-between";
      li.dataset.name = name;
      li.innerHTML = `
        <div>
          <div class="font-medium">${name}</div>
          <div class="text-slate-500 text-xs">${meta} · <span class="status">${status}</span></div>
        </div>
      `;
      queueEl.appendChild(li);
      return li;
    }
    function setRowStatus(li, status, danger=false) {
      const s = li.querySelector('.status');
      s.textContent = status;
      s.className = "status " + (danger ? "text-red-500" : "text-slate-500");
    }
    function clearQueue() { queueEl.innerHTML = ''; }

    function appendToNotes(header, text) {
      const ta = $('#notes');
      const section = (header ? `[${header}]\n` : '') + (text || '');
      ta.value = (ta.value ? ta.value + '\n---\n' : '') + section;
    }

    function setPreviewHTML(html) {
      previewEl.innerHTML = html || `<p class="text-slate-500">L’anteprima comparirà qui…</p>`;
    }
    function escapeHTML(s='') {
      return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // ---------- health check (blob-url & extract) ----------
    async function health() {
      const badge = $('#healthBadge');
      try {
        const b = await fetch('/api/blob-url');
        const e = await fetch('/api/extract', { method:'GET' });
        if (b.ok && e.ok) {
          badge.textContent = 'API ok';
          badge.className = "text-xs px-2.5 py-1 rounded-full bg-emerald-100 text-emerald-700";
        } else {
          badge.textContent = 'API parziali';
          badge.className = "text-xs px-2.5 py-1 rounded-full bg-amber-100 text-amber-700";
        }
      } catch {
        badge.textContent = 'API offline';
        badge.className = "text-xs px-2.5 py-1 rounded-full bg-rose-100 text-rose-700";
      }
    }

    // ---------- Upload pipeline ----------
    async function getUploadUrl() {
      const r = await fetch('/api/blob-url');
      if (!r.ok) throw new Error('blob-url non disponibile');
      const j = await r.json();
      if (!j.uploadUrl) throw new Error('uploadUrl mancante');
      return j.uploadUrl;
    }
