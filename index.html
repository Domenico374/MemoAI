<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Memo AI</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- DOCX preview -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <!-- PDF preview -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      var lib = window.pdfjsLib || (window['pdfjs-dist/build/pdf'] || null);
      if (lib && lib.GlobalWorkerOptions) {
        lib.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        window.pdfjsLib = lib;
      }
    });
  </script>

  <style>
    /* ... STILI UGUALI A PRIMA ... */
  </style>
</head>

<body class="text-slate-800 theme-aqua">
  <!-- Toasts -->
  <div id="toast" class="notification"></div>

  <!-- NAV -->
  <header id="main-navbar" class="sticky top-0 z-30 border-b bg-white/90 backdrop-blur">
    <div class="max-w-4xl mx-auto px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-blue-600 font-bold text-xl">Memo AI</span>
        <span class="text-xs px-2 py-1 ml-3 rounded-full bg-emerald-100 text-emerald-700" id="navStatusApi">checkingâ€¦</span>
      </div>
      <nav class="hidden md:flex gap-6">
        <a class="text-slate-500 hover:text-blue-600 font-semibold transition" href="#">Home</a>
        <a class="text-slate-500 hover:text-blue-600 font-semibold transition" href="#">Guida</a>
        <a class="text-slate-500 hover:text-blue-600 font-semibold transition" href="#">Info</a>
      </nav>
    </div>
  </header>

  <!-- ... (resto HTML identico alla tua versione) ... -->

  <script>
    /* ======= Utils / UI ======= */
    // ... identico alla tua versione ...

    /* ======= API helpers & health ======= */
    async function health(){
      var badge = $('#navStatusApi');
      try {
        const tests = ["/api/upload","/api/extract","/api/cleanup","/api/format"];
        const results = await Promise.all(
          tests.map(u => fetch(u, { method:'OPTIONS' }))
        );

        if (results.every(r=>r.ok)) {
          badge.textContent = 'API ok';
          badge.className = "text-xs px-2 py-1 ml-3 rounded-full bg-emerald-100 text-emerald-700";
        } else if (results.some(r=>r.ok)) {
          badge.textContent = 'API parziali';
          badge.className = "text-xs px-2 py-1 ml-3 rounded-full bg-amber-100 text-amber-700";
        } else {
          badge.textContent = 'API offline';
          badge.className = "text-xs px-2 py-1 ml-3 rounded-full bg-rose-100 text-rose-700";
        }
      } catch(err){
        badge.textContent = 'API offline';
        badge.className = "text-xs px-2 py-1 ml-3 rounded-full bg-rose-100 text-rose-700";
      }
    }

    async function uploadViaApi(file){
      const fd = new FormData();
      fd.append('file', file, file.name || 'file');
      fd.append('contentType', file.type || 'application/octet-stream');

      const r = await fetch('/api/upload', { method:'POST', body: fd });
      const j = await r.json().catch(()=> ({}));

      if (!r.ok) throw new Error(j?.message || j?.error || 'Upload fallito');

      const url = j?.data?.url || j?.url;
      if (!url) throw new Error('Upload riuscito ma URL mancante');
      return url;
    }

    async function extractWithUrl(blobUrl, name){
      const r = await fetch('/api/extract', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ fileUrl: blobUrl, fileName: name })
      });
      const j = await r.json().catch(()=> ({}));

      if (!r.ok) throw new Error(j?.message || j?.error || 'Errore estrazione');
      return j?.text || j?.content || j?.result || '';
    }

    async function transcribeWithUrl(blobUrl){
      try {
        const r = await fetch('/api/whisper', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ url: blobUrl })
        });
        const j = await r.json().catch(()=> ({}));
        if (r.ok && j?.text) return j.text;
        if (!r.ok) throw new Error(j?.message || j?.error || 'Errore whisper');
      } catch(_) { }

      // fallback se hai un endpoint alternativo
      const r2 = await fetch('/api/transcribe-audio', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ url: blobUrl })
      });
      const j2 = await r2.json().catch(()=> ({}));
      if (!r2.ok || !j2?.text) throw new Error(j2?.message || j2?.error || 'Errore trascrizione');
      return j2.text || '';
    }

    /* ===== resto JS invariato ===== */
    // ... tutto il resto uguale alla tua ultima versione ...
    health();
  </script>
</body>
</html>
