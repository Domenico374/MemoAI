import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import matplotlib.pyplot as plt
import seaborn as sns
from wordcloud import WordCloud
import json
import base64
from datetime import datetime
import io
import os
import tempfile
from streamlit_dropzone import dropzone
import streamlit.components.v1 as components
import time

# Configurazione pagina
st.set_page_config(
    page_title="Memo AI Advanced",
    page_icon="üöÄ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Inizializzazione session state
if 'uploaded_files' not in st.session_state:
    st.session_state.uploaded_files = []
if 'analysis_results' not in st.session_state:
    st.session_state.analysis_results = {}
if 'participation_chart' not in st.session_state:
    st.session_state.participation_chart = None
if 'sentiment_chart' not in st.session_state:
    st.session_state.sentiment_chart = None

# Funzione per distruggere i chart esistenti
def destroy_existing_charts():
    """Distrugge i chart esistenti prima di crearne di nuovi"""
    try:
        # Pulizia semplice - Plotly gestisce automaticamente i canvas
        st.session_state.participation_chart = None
        st.session_state.sentiment_chart = None
        
        # Forza un refresh per pulire eventuali canvas
        st.rerun()
            
    except Exception as e:
        print(f"Pulizia chart: {e}")

# Stili CSS personalizzati
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 2rem;
        font-weight: bold;
    }
    .success-box {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
    }
    .error-box {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
    }
    .file-info {
        background-color: #e9ecef;
        border-radius: 5px;
        padding: 10px;
        margin: 5px 0;
    }
    .analysis-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        border-left: 4px solid #1f77b4;
    }
</style>
""", unsafe_allow_html=True)

# Header principale
st.markdown('<div class="main-header">üöÄ Memo AI Advanced</div>', unsafe_allow_html=True)

# Sidebar per upload e controlli
with st.sidebar:
    st.header("üìÅ Upload File")
    
    # Dropzone per upload
    uploaded_files = dropzone(
        allowed_files=["pdf", "txt", "docx", "png", "jpg", "jpeg"],
        max_files=10,
        label="Trascina i file qui o clicca per selezionare"
    )
    
    if uploaded_files:
        st.session_state.uploaded_files = uploaded_files
        st.markdown(f'<div class="success-box">üéØ File trascinati: {len(uploaded_files)}</div>', unsafe_allow_html=True)
        
        for file in uploaded_files:
            file_size = len(file['fileBytes']) / 1024
            st.markdown(f'<div class="file-info">üìÑ {file["file_name"]} ({file_size:.1f} KB)</div>', unsafe_allow_html=True)

# Area principale
tab1, tab2, tab3 = st.tabs(["üìä Dashboard", "ü§ñ Analisi AI", "‚öôÔ∏è Configurazione"])

with tab1:
    st.header("Dashboard Principale")
    
    if st.session_state.uploaded_files:
        st.markdown(f'<div class="success-box">üìÅ File selezionati: {len(st.session_state.uploaded_files)}</div>', unsafe_allow_html=True)
        
        # Pulsante per avviare l'analisi
        if st.button("üöÄ Avvia Analisi AI Completa", type="primary"):
            with st.spinner("Elaborazione in corso..."):
                for file in st.session_state.uploaded_files:
                    try:
                        st.markdown(f'<div class="file-info">üìÑ Elaborando: {file["file_name"]} ({len(file["fileBytes"])/1024:.1f} KB)</div>', unsafe_allow_html=True)
                        
                        # Simulazione upload e fallback
                        time.sleep(1)
                        if len(file["fileBytes"]) > 100000:  # Simula fallback per file grandi
                            st.markdown('<div class="error-box">‚ö†Ô∏è Upload fallito, provo fallback client...</div>', unsafe_allow_html=True)
                            time.sleep(0.5)
                            st.markdown(f'<div class="success-box">‚úÖ Fallback client riuscito: {file["file_name"]}</div>', unsafe_allow_html=True)
                        else:
                            st.markdown(f'<div class="success-box">‚úÖ Upload riuscito: {file["file_name"]}</div>', unsafe_allow_html=True)
                        
                        # Avvia analisi AI
                        st.markdown('<div class="success-box">ü§ñ Avvio analisi AI...</div>', unsafe_allow_html=True)
                        
                        # Distruggi chart esistenti prima della nuova analisi
                        destroy_existing_charts()
                        
                        # Simulazione analisi AI
                        time.sleep(2)
                        
                        # Risultati simulati dell'analisi
                        analysis_result = {
                            "sentiment": {
                                "positive": 65,
                                "negative": 15,
                                "neutral": 20
                            },
                            "participation": {
                                "Speaker A": 35,
                                "Speaker B": 25,
                                "Speaker C": 40
                            },
                            "key_topics": ["IA", "Machine Learning", "Analisi Dati", "Automazione"],
                            "word_frequency": {"IA": 12, "Machine Learning": 8, "Analisi": 6, "Dati": 5, "Automazione": 4},
                            "summary": "Questa riunione ha affrontato principalmente temi di intelligenza artificiale e machine learning, con particolare focus sull'analisi dati e processi di automazione."
                        }
                        
                        st.session_state.analysis_results[file["file_name"]] = analysis_result
                        st.markdown(f'<div class="success-box">‚úÖ Analisi completata per: {file["file_name"]}</div>', unsafe_allow_html=True)
                        
                    except Exception as e:
                        st.markdown(f'<div class="error-box">‚ùå Errore analisi AI: {str(e)}</div>', unsafe_allow_html=True)
    
    else:
        st.info("üìé Trascina i file nella sidebar per iniziare l'analisi")

with tab2:
    st.header("Analisi AI Dettagliata")
    
    if not st.session_state.analysis_results:
        st.warning("Nessuna analisi disponibile. Carica i file e avvia l'analisi nella tab Dashboard.")
    else:
        for filename, analysis in st.session_state.analysis_results.items():
            with st.expander(f"üìä Analisi: {filename}", expanded=True):
                
                # Distruggi chart esistenti prima di crearne di nuovi
                destroy_existing_charts()
                
                # Layout a colonne per i metric
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.metric("Sentimento Positivo", f"{analysis['sentiment']['positive']}%")
                with col2:
                    st.metric("Sentimento Neutro", f"{analysis['sentiment']['neutral']}%")
                with col3:
                    st.metric("Sentimento Negativo", f"{analysis['sentiment']['negative']}%")
                
                # Chart partecipazione
                st.subheader("üéØ Partecipazione Speaker")
                participation_data = analysis['participation']
                
                # Crea chart partecipazione con Plotly - CON CHIAVE UNIVOCA
                fig_participation = px.pie(
                    values=list(participation_data.values()),
                    names=list(participation_data.keys()),
                    title="Distribuzione Partecipazione"
                )
                st.plotly_chart(fig_participation, use_container_width=True, key=f"participation_{filename}")
                
                # Chart sentiment
                st.subheader("üòä Analisi Sentiment")
                sentiment_data = analysis['sentiment']
                
                # Crea chart sentiment con Plotly - CON CHIAVE UNIVOCA
                fig_sentiment = px.bar(
                    x=list(sentiment_data.keys()),
                    y=list(sentiment_data.values()),
                    title="Distribuzione Sentiment",
                    color=list(sentiment_data.keys()),
                    color_discrete_map={
                        'positive': '#2ecc71',
                        'neutral': '#f39c12', 
                        'negative': '#e74c3c'
                    }
                )
                st.plotly_chart(fig_sentiment, use_container_width=True, key=f"sentiment_{filename}")
                
                # Word cloud e topic
                col4, col5 = st.columns(2)
                
                with col4:
                    st.subheader("‚òÅÔ∏è Word Cloud")
                    # Crea word cloud
                    wordcloud = WordCloud(
                        width=400, 
                        height=300, 
                        background_color='white'
                    ).generate_from_frequencies(analysis['word_frequency'])
                    
                    # Display word cloud
                    fig_wordcloud, ax = plt.subplots(figsize=(10, 5))
                    ax.imshow(wordcloud, interpolation='bilinear')
                    ax.axis('off')
                    st.pyplot(fig_wordcloud)
                    plt.close(fig_wordcloud)  # IMPORTANTE: chiudi la figura per liberare memoria
                
                with col5:
                    st.subheader("üéØ Topic Principali")
                    for i, topic in enumerate(analysis['key_topics'], 1):
                        st.write(f"{i}. {topic}")
                
                # Summary
                st.subheader("üìù Riassunto")
                st.write(analysis['summary'])

with tab3:
    st.header("Configurazione")
    
    st.subheader("Impostazioni Analisi")
    analysis_type = st.selectbox(
        "Tipo di Analisi",
        ["Completa", "Solo Sentiment", "Solo Partecipazione", "Solo Topic"]
    )
    
    st.subheader("Preferenze Visualizzazione")
    chart_style = st.selectbox(
        "Stile Chart",
        ["Plotly", "Matplotlib", "Seaborn"]
    )
    
    st.subheader("Export Dati")
    if st.session_state.analysis_results:
        if st.button("üì• Esporta Analisi come JSON"):
            # Crea JSON esportabile
            export_data = {
                "export_date": datetime.now().isoformat(),
                "analyses": st.session_state.analysis_results
            }
            
            # Converti in JSON
            json_str = json.dumps(export_data, indent=2, ensure_ascii=False)
            
            # Crea download button
            st.download_button(
                label="Scarica JSON",
                data=json_str,
                file_name=f"memo_ai_analysis_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json",
                mime="application/json"
            )
    else:
        st.warning("Nessuna analisi disponibile per l'export")

# Footer
st.markdown("---")
st.markdown(
    "<div style='text-align: center; color: #666;'>"
    "üöÄ Memo AI Advanced - Strumento di analisi intelligente per documenti e riunioni"
    "</div>",
    unsafe_allow_html=True
)

